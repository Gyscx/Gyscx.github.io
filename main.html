<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>套装投票 | Shadow Fight 3 中文 Wiki</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body class="theme-accent page-main">
    <header class="top">
        <div class="logo"><img src="./Logo.png" alt="暗影格斗3" height="50"> </div>
        <nav>
            <a href="index.html">首页</a>
            <a href="factions.html">派系</a>
            <a href="guides.html">攻略</a>
            <a href="codex.html">图鉴</a>
            <a href="story.html">剧情</a>
            <a href="http://192.168.1.10:3000/register.html"><span style="color: greenyellow;">注册</span></a>
            <a href="http://192.168.1.10:3000/login.html"><span style="color: red;">登录</span></a>
        </nav>
    </header>

    <main class="container">
        <div class="main-container">
            <div class="top-bar">
                <div class="user-controls">
                    <button class="logout-btn" onclick="logout()">退出登录</button>
                    <span id="adminLink"></span>
                </div>
            </div>

            <div class="content-card">
                <div class="section-header">
                    <h1>投票系统</h1>
                    <p class="muted">参与社区投票，分享您的意见</p>
                </div>

                <div class="poll-list-section">
                    <h2>投票列表</h2>
                    <ul id="pollList" class="poll-list"></ul>
                </div>

                <div class="poll-detail-section" id="pollDetail">
                    <!-- 投票详情将动态加载到这里 -->
                </div>
            </div>
        </div>
    </main>

    <script>
        const token = localStorage.getItem("token");
        if (!token) location.href = "login.html";

        const role = localStorage.getItem("role");
        document.getElementById("adminLink").innerHTML = role === "admin" ?
            '<a href="admin.html" class="admin-link">创建新投票</a>' : '';

        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("role");
            location.href = "login.html";
        }

        async function api(path, options = {}) {
            options.headers = {
                ...(options.headers || {}),
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            };
            const res = await fetch(path, options);
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "请求失败");
            return data;
        }

        async function loadPolls() {
            try {
                const polls = await api("/api/polls");
                const ul = document.getElementById("pollList");
                ul.innerHTML = "";

                if (polls.length === 0) {
                    ul.innerHTML = '<li class="no-polls">暂无投票活动</li>';
                    return;
                }

                polls.forEach(p => {
                    const li = document.createElement("li");
                    li.className = "poll-item";
                    li.innerHTML = `
                        <a href="#" onclick="showPoll(${p.id})" class="poll-link">
                            <span class="poll-title">${p.title}</span>
                            <span class="poll-arrow">→</span>
                        </a>
                    `;
                    ul.appendChild(li);
                });
            } catch (error) {
                console.error("加载投票列表失败:", error);
                document.getElementById("pollList").innerHTML = '<li class="error">加载失败，请刷新页面</li>';
            }
        }

        async function showPoll(id) {
            try {
                const data = await api(`/api/polls/${id}`);
                const { poll, options, voted } = data;

                let html = `
                    <div class="poll-header">
                        <h2>${poll.title}</h2>
                        <div class="poll-status ${voted ? 'voted' : 'not-voted'}">
                            ${voted ? '已投票' : '未投票'}
                        </div>
                    </div>
                `;

                if (!voted) {
                    html += `
                        <div class="vote-form">
                            <h4>请选择一个选项投票：</h4>
                            <div class="options-list">
                    `;

                    options.forEach(o => {
                        html += `
                            <label class="option-radio">
                                <input type="radio" name="opt" value="${o.id}">
                                <span class="radio-custom"></span>
                                <span class="option-text">${o.text}</span>
                            </label>
                        `;
                    });

                    html += `
                            </div>
                            <button class="vote-btn" onclick="vote(${id})">提交投票</button>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="poll-results">
                            <button class="results-btn" onclick="loadResults(${id})">查看结果</button>
                            <div id="results" class="results-container"></div>
                        </div>
                    `;
                }

                document.getElementById("pollDetail").innerHTML = html;

                if (voted) {
                    await loadResults(id);
                }
            } catch (error) {
                console.error("加载投票详情失败:", error);
                document.getElementById("pollDetail").innerHTML = '<div class="error">加载失败，请刷新页面</div>';
            }
        }

        async function vote(pollId) {
            const selected = document.querySelector('input[name="opt"]:checked');
            if (!selected) return alert("请选择一个选项");

            try {
                await api(`/api/polls/${pollId}/vote`, {
                    method: "POST",
                    body: JSON.stringify({ optionId: selected.value })
                });

                alert("投票成功，现在可以查看结果");
                showPoll(pollId);
            } catch (error) {
                alert("投票失败: " + error.message);
            }
        }

        async function loadResults(pollId) {
            try {
                const rows = await api(`/api/polls/${pollId}/results`);
                const total = rows.reduce((sum, r) => sum + r.count, 0);

                let html = `<h4>投票结果（总票数：${total}）</h4>`;
                rows.forEach(r => {
                    const pct = total ? ((r.count / total) * 100).toFixed(1) : 0;
                    const width = total ? (r.count / total) * 100 : 0;

                    html += `
                        <div class="result-item">
                            <div class="result-info">
                                <span class="result-text">${r.text}</span>
                                <span class="result-stats">${r.count} 票（${pct}%）</span>
                            </div>
                            <div class="result-bar">
                                <div class="result-fill" style="width: ${width}%"></div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById("results").innerHTML = html;
            } catch (error) {
                console.error("加载结果失败:", error);
                document.getElementById("results").innerHTML = '<div class="error">加载结果失败</div>';
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            loadPolls();
        });
    </script>

    <footer>
        本站为 Shadow Fight 3 非官方中文 Wiki，与 Nekki/万达院线游戏(互爱互动) 无隶属关系。
    </footer>
</body>

</html>